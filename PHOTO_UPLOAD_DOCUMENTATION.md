# Документация по загрузке фото профиля

## Обзор функциональности

Добавлена возможность загрузки и отображения фото профиля сотрудников с автоматическим включением в генерируемые открытки.

## Функции

### 1. Загрузка фото профиля

**API эндпоинты:**
- `POST /employees/me/photo` - загрузка фото профиля
- `DELETE /employees/me/photo` - удаление фото профиля

**Ограничения:**
- Максимальный размер файла: 5MB
- Поддерживаемые форматы: все типы изображений
- Автоматическое удаление старого фото при загрузке нового

**Процесс обновления:**
- Фото загружается через отдельный эндпоинт
- После успешной загрузки профиль обновляется автоматически
- Форма редактирования профиля больше не содержит поле для URL фото

### 2. Интерфейс пользователя

**Страница профиля (`/dashboard/profile`):**
- Кнопка "Загрузить фото" при отсутствии фото
- Кнопки "Изменить" и "Удалить" при наличии фото
- Предпросмотр загруженного фото в круглом формате
- Валидация файлов на стороне клиента
- Фото управляется отдельно от основной информации профиля

### 3. Генерация открыток

**Автоматическое включение фото:**
- Фото сотрудника автоматически добавляется в открытку (правый верхний угол)
- Размер фото: 100x100px, круглая обрезка
- Fallback: если фото недоступно, открытка генерируется без фото

**Технические детали:**
- Используется `loadImage()` для загрузки фото сотрудника
- Круглая обрезка с помощью Canvas API
- Обработка ошибок с логированием

## Структура файлов

### Backend
```
backend/
├── src/employees/
│   ├── employees.controller.ts    # Эндпоинты для загрузки фото
│   └── dto/
│       └── update-profile.dto.ts  # Валидация photoUrl
├── src/card-generator/
│   └── card-generator.service.ts  # Генерация с фото
├── src/mailing/
│   └── mailing.service.ts         # Отправка с фото
└── public/photos/                 # Хранение фото
```

### Frontend
```
frontend/src/app/dashboard/profile/
└── page.tsx                       # Интерфейс загрузки фото
frontend/src/lib/
└── api.ts                         # API методы для фото
```

## Настройка

### Установка зависимостей
```bash
cd backend
npm install multer @types/multer
```

### Настройка CORS
Убедитесь, что статические файлы доступны по адресу `http://localhost:3000/photos/`

### Миграции базы данных
Поле `photoUrl` уже существует в модели `Employee`, дополнительных миграций не требуется.

## Использование

### Для сотрудников
1. Перейдите в "Мой профиль" в веб-интерфейсе
2. Нажмите "Редактировать"
3. Используйте кнопку "Загрузить фото" для добавления изображения
4. Сохраните изменения

### Для разработчиков

**Загрузка фото через API:**
```javascript
const formData = new FormData();
formData.append('photo', file);
await fetch('/employees/me/photo', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${token}` },
  body: formData
});
```

**Получение данных с фото:**
```javascript
const profile = await fetch('/employees/me/profile', {
  headers: { 'Authorization': `Bearer ${token}` }
});
const data = await profile.json();
console.log(data.photoUrl); // URL фото или null
```

## Устранение неполадок

### Ошибки загрузки
- **"Только изображения разрешены"**: Выберите файл изображения (jpg, png, gif, etc.)
- **"Размер файла не должен превышать 5MB"**: Сожмите изображение перед загрузкой

### Ошибки генерации открыток
- Если фото недоступно, открытка генерируется без фото сотрудника
- Проверьте логи сервера для детальной информации об ошибках

### Доступ к файлам
- Фото сохраняются в `backend/public/photos/`
- Доступны по URL: `http://localhost:3000/photos/filename.jpg`

## Безопасность

- Валидация типов файлов на сервере и клиенте
- Ограничение размера файлов (5MB)
- Автоматическое удаление старых фото
- Изоляция файлов в отдельной директории